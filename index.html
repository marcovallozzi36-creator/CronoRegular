<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Regularidad Web - Vallozzi</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #1f2937;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e2e8f0;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
    }

    /* SPLASH / BARRA DE CARGA */
    #splash {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 11000;
      flex-direction: column;
      transition: opacity .4s ease;
    }
    #splash.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .splash-inner {
      max-width: 320px;
      width: 90%;
      text-align: center;
    }
    .splash-logo {
      max-width: 180px;
      max-height: 100px;
      object-fit: contain;
      margin: 0 auto 1rem auto;
      display: block;
    }
    .splash-text {
      font-size: .9rem;
      margin-bottom: .6rem;
      opacity: .85;
    }
    .splash-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: rgba(148,163,184,.3);
      overflow: hidden;
      box-shadow: 0 0 12px rgba(15,23,42,.9);
    }
    .splash-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #16a34a, #22c55e, #a3e635);
      transition: width .08s linear;
    }
    .splash-percent {
      margin-top: .45rem;
      font-size: .8rem;
      opacity: .85;
    }

    /* LOGIN */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.96);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 12000;
    }
    .login-overlay.hidden { display:none; }
    .login-card {
      background: #020617;
      border-radius: .9rem;
      padding: 1.4rem 1.6rem;
      width: 320px;
      max-width: 90%;
      box-shadow: 0 20px 50px rgba(0,0,0,.7);
    }
    .login-card h2 { margin-top:0; margin-bottom:.3rem; font-size:1.1rem; }
    .login-sub { font-size:.8rem; opacity:.8; margin-bottom:.8rem; }
    .login-actions { display:flex; gap:.5rem; margin-top:1rem; justify-content:flex-end; flex-wrap:wrap; }

    .topbar {
      background: rgba(15,23,42,.7);
      border-bottom: 1px solid rgba(226,232,240,.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: .6rem 1.2rem;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .topbar-left { display:flex; flex-direction:column; gap:.25rem; }
    .topbar-title { font-weight:700; }
    .topbar-small { font-size:.7rem; opacity:.7; }
    .topbar-right { display:flex; gap:.5rem; align-items:center; }

    header {
      text-align: center;
      padding: 1rem 0 0.5rem 0;
    }
    h1 { font-size: 1.1rem; margin: 0; opacity: 0.7; }
    #raceTime {
      display: block;
      font-size: 2.8rem;
      font-weight: 800;
      margin-top: .3rem;
      letter-spacing: 1px;
      color: var(--accent);
      text-shadow: 0 0 8px rgba(34,197,94,.3);
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: .7rem;
      margin-top: .5rem;
      flex-wrap: wrap;
    }
    .container {
      padding: 1.5rem;
      max-width: 1100px;
      margin: 0 auto;
    }
    .card {
      background: var(--card);
      border-radius: .8rem;
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
    }
    label { display:block; margin-bottom:.35rem; font-size:.75rem; opacity:.9; }
    input, select {
      width:100%; padding:.45rem .5rem; border-radius:.4rem;
      border:1px solid rgba(226,232,240,.1);
      background:rgba(15,23,42,.3); color:var(--text); outline:none;
      box-sizing: border-box;
    }
    input:focus, select:focus { border-color:rgba(34,197,94,.5); }
    button {
      border:none; background:var(--accent); color:#03140b;
      padding:.5rem .8rem; border-radius:.4rem; cursor:pointer;
      font-weight:600;
    }
    button.secondary {
      background:rgba(226,232,240,.1); color:var(--text);
    }
    button:disabled {
      opacity:.4;
      cursor:not-allowed;
    }
    table { width:100%; border-collapse:collapse; margin-top:.5rem; }
    th,td { padding:.5rem; text-align:left; border-bottom:1px solid rgba(226,232,240,.05); font-size:.83rem; }
    .tag { display:inline-block; padding:.15rem .5rem; border-radius:.4rem; font-size:.7rem; text-transform:uppercase; }
    .tag-point { background:rgba(34,197,94,.12); color:#bbf7d0; }
    .tag-auto { background:rgba(249,115,22,.12); color:#ffedd5; }
    .warn-badge {
      display:inline-block;
      margin-left:.3rem;
      background: #fbbf24;
      color:#1f2937;
      font-size:.6rem;
      padding:.1rem .35rem;
      border-radius:.35rem;
      font-weight:700;
    }
    .diff-green { color:#22c55e; font-weight:600; }
    .diff-red { color:#ef4444; font-weight:600; }

    .points-form {
      display:grid;
      grid-template-columns: repeat(8, minmax(90px, 1fr));
      gap:.8rem;
      align-items: end;
    }

    .actions-cell { display:flex; gap:.3rem; flex-wrap:wrap; }

    #chartCard {
      display:none;
    }
    .muted { opacity:.6; font-size:.7rem; }

    .etapas-list {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
    }
    .etapa-btn {
      border: none;
      background: rgba(226,232,240,.05);
      color: var(--text);
      padding: .45rem .7rem;
      border-radius: .45rem;
      cursor: pointer;
      display: flex;
      gap: .35rem;
      align-items: center;
      font-size: .8rem;
      flex-wrap: wrap;
    }
    .etapa-btn.active {
      background: rgba(34,197,94,.25);
      outline: 1px solid rgba(34,197,94,.5);
    }
    .etapa-name { cursor: pointer; }
    .etapa-total { font-size: .7rem; opacity: .8; }
    .footer-summary { margin-top: .5rem; font-weight: 600; }

    .inline-timer {
      font-size: .8rem;
      font-weight: 600;
      opacity: .8;
      margin-right: .7rem;
    }

    #pdfChartCanvas { display:none; }

    .adj-arrow {
      margin-right:.25rem;
      font-weight:700;
    }
    .adj-up { color:#22c55e; }
    .adj-down { color:#ef4444; }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
    }

    /* gr√°fico responsivo (canvas de pantalla) */
    #diffChart {
      width: 100% !important;
      max-width: 100%;
      min-height: 200px;
      display: block;
    }

    /* BOT√ìN GIGANTE DE TOP */
    .big-top-wrapper {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 5000;
      pointer-events: none;
    }
    .big-top-btn {
      width: 90px;
      height: 90px;
      border-radius: 999px;
      font-size: 1.2rem;
      border: none;
      background: var(--accent);
      color: #03140b;
      box-shadow: 0 10px 25px rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      pointer-events: auto;
    }

    @media (max-width: 980px) {
      .points-form { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
      .topbar { flex-direction: column; align-items: flex-start; }
      .topbar-right { margin-top:.4rem; }
    }

    @media (max-width: 640px) {
      .container { padding: 1rem .6rem; }
      h1 { font-size: 1rem; }
      #raceTime { font-size: 2.1rem; }
      .controls { flex-direction: column; align-items:center; }
      th, td { font-size: .75rem; white-space: nowrap; }
      .topbar-title { font-size: .8rem; }
      .topbar-small { font-size: .65rem; }
    }

    @media (min-width: 900px) {
      .big-top-btn {
        width: 80px;
        height: 80px;
      }
    }
  </style>

  <!-- librer√≠as para PDF (sin chart.js) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- SPLASH / BARRA DE CARGA -->
  <div id="splash">
    <div class="splash-inner">
      <img id="splashLogo" class="splash-logo" src="" alt="Logo Regularidad" />
      <div class="splash-text">Cargando aplicaci√≥n de regularidad...</div>
      <div class="splash-bar">
        <div class="splash-bar-fill" id="splashBarFill"></div>
      </div>
      <div class="splash-percent" id="splashPercent">0%</div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginOverlay" class="login-overlay hidden">
    <div class="login-card">
      <h2>Acceso Regularidad</h2>
      <p class="login-sub">Cre√° tu usuario o ingres√° si ya lo ten√©s.</p>
      <label>Usuario</label>
      <input id="loginUser" autocomplete="username" />
      <label>Contrase√±a</label>
      <input id="loginPass" type="password" autocomplete="current-password" />
      <div class="login-actions">
        <button id="loginBtn">Ingresar</button>
        <button id="registerBtn" class="secondary">Registrar</button>
      </div>
    </div>
  </div>

  <!-- barra piloto/navegante -->
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-title" id="crewText">Piloto: - / Navegante: - / Veh√≠culo: -</div>
      <div class="topbar-small" id="dateText">Fecha: --/--/----</div>
    </div>
    <div class="topbar-right">
      <div class="topbar-small" id="clockText">Hora: --:--:--</div>
      <button id="changeCrewBtn" class="secondary">Cambiar datos</button>
    </div>
  </div>

  <header>
    <h1>üü¢ Regularidad - Cron√≥metro</h1>
    <span id="raceTime">00:00:00.000</span>
    <div class="controls">
      <button id="startBtn">Largar</button>
      <button id="pauseBtn" class="secondary">Pausar</button>
      <button id="resetBtn" class="secondary">Reiniciar</button>
      <button id="clearBtn" class="secondary">üóëÔ∏è Borrar puntos</button>
      <button id="exportBtn" class="secondary">üìÑ Exportar PDF (rally actual)</button>
      <button id="fullscreenBtn" class="secondary">‚õ∂ Pantalla completa</button>
    </div>
  </header>

  <div class="container">
    <!-- RALLIES -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;">
        <h2 style="margin-top:0; font-size:1rem;">Rallies</h2>
        <div style="display:flex; gap:.4rem; flex-wrap:wrap;">
          <button id="addRallyBtn">‚ûï Nuevo rally</button>
          <button id="finalizeRallyBtn" class="secondary">üèÅ Finalizar rally</button>
        </div>
      </div>
      <div id="ralliesContainer" class="etapas-list"></div>
    </div>

    <!-- ETAPAS -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;">
        <h2 style="margin-top:0; font-size:1rem;">Etapas (del rally seleccionado)</h2>
        <button id="addStageBtn">‚ûï Agregar etapa</button>
      </div>
      <div id="stagesContainer" class="etapas-list"></div>
      <p id="autoSummary" class="footer-summary"></p>
    </div>

    <!-- Formulario -->
    <div class="card">
      <h2 style="margin-top:0; font-size:1rem;">Cargar POINT / Autocontrol (en etapa seleccionada)</h2>
      <div class="points-form">
        <div><label>Nombre</label><input id="name" placeholder="AC 1, POINT 3..." /></div>
        <div><label>Tipo</label>
          <select id="type">
            <option value="POINT">POINT</option>
            <option value="AUTO">Autocontrol</option>
          </select>
        </div>
        <div><label>HS</label><input id="hs" type="number" min="0" value="0"/></div>
        <div><label>MM</label><input id="mm" type="number" min="0" max="59" value="0"/></div>
        <div><label>SS</label><input id="ss" type="number" min="0" max="59" value="0"/></div>
        <div><label>ML</label><input id="ml" type="number" min="0" max="999" value="0"/></div>
        <div><label>Km (acum.)</label><input id="km" type="number" step="0.01" placeholder="6.40"/></div>
        <div><label>Velocidad (km/h)</label><input id="speed" type="number" step="0.1" placeholder="45"/></div>
      </div>
      <div style="margin-top:.8rem;">
        <button id="addBtn">Agregar punto</button>
        <button id="cancelEditBtn" class="secondary" style="display:none;">Cancelar edici√≥n</button>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;">
        <h2 style="margin-top:0; font-size:1rem;" id="pointsTitle">Puntos de la etapa</h2>
        <div style="display:flex; align-items:center; gap:.4rem; flex-wrap:wrap; justify-content:flex-end;">
          <span id="raceTimeInline" class="inline-timer">00:00:00.000</span>
          <button id="finalizeStageBtn" class="secondary">üîí Finalizar etapa</button>
          <button id="reopenStageBtn" class="secondary" disabled>üîì Reabrir etapa</button>
          <button id="toggleChartBtn" class="secondary">üìä Ver gr√°fico</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Punto</th>
              <th>Tipo</th>
              <th>Km</th>
              <th>Vel</th>
              <th>Ideal</th>
              <th>Real</th>
              <th>Dif</th>
              <th>Dif %</th>
              <th>Ajuste</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="pointsTable"></tbody>
        </table>
      </div>
      <p id="stageSummary" class="footer-summary"></p>
    </div>

    <!-- Gr√°fico en pantalla -->
    <div class="card" id="chartCard" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;">
        <h2 style="margin-top:0; font-size:1rem;">Diferencia vs tiempo oficial</h2>
        <select id="chartStageSelect"></select>
      </div>
      <canvas id="diffChart" height="200"></canvas>
      <p class="muted" id="chartHint">Valores en segundos. Positivo = llegaste tarde. Negativo = llegaste antes.</p>
    </div>
  </div>

  <!-- canvas oculto para PDF -->
  <canvas id="pdfChartCanvas" width="800" height="300"></canvas>

  <!-- BOT√ìN GIGANTE PARA TOP -->
  <div class="big-top-wrapper">
    <button id="bigTopBtn" class="big-top-btn">TOP</button>
  </div>

  <script>
    // üîß CONFIGURACI√ìN SPLASH: cambi√° esta URL por la imagen que quieras mostrar
    const SPLASH_DURATION = 3500; // ms
    const SPLASH_IMAGE_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/Flag_of_Racing.svg/512px-Flag_of_Racing.svg.png"; // <- CAMBI√Å ESTA URL

    const STORAGE_CREW = "regularidad_crew_v1";
    const STORAGE_RACE = "regularidad_race_v1";

    const STORAGE_USERS = "regularidad_users_v1";
    const STORAGE_CURRENT_USER = "regularidad_current_user_v1";

    function dataKeyForUser(username) {
      return "regularidad_data_v1_" + username;
    }

    let userData = { rallies: [], selectedRallyId: null, selectedStageId: null };
    let currentUser = null;

    // etapas del rally seleccionado
    let stages = [];
    let selectedStageId = null;

    let raceState = { startedAt: null, isPaused: false, pausedElapsed: 0 };
    let raceTimerInterval = null;

    function toMs(h,m,s,ml){ return (h*3600 + m*60 + s)*1000 + ml; }
    function formatMs(ms){
      if(ms==null) return "--";
      const totalSeconds = Math.floor(ms/1000);
      const h = Math.floor(totalSeconds/3600);
      const m = Math.floor((totalSeconds%3600)/60);
      const s = totalSeconds%60;
      const ml = ms%1000;
      return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(ml).padStart(3,"0")}`;
    }
    function getCurrentElapsedMs(){
      if(!raceState.startedAt) return 0;
      return raceState.isPaused ? raceState.pausedElapsed : Date.now() - raceState.startedAt;
    }
    function updateRaceDisplay(){
      const formatted = formatMs(getCurrentElapsedMs());
      document.getElementById("raceTime").textContent = formatted;
      const inline = document.getElementById("raceTimeInline");
      if (inline) inline.textContent = formatted;
    }
    function startRaceTimerLoop(){ clearInterval(raceTimerInterval); raceTimerInterval = setInterval(updateRaceDisplay, 100); }

    function startClock(){
      function tick(){
        const now = new Date();
        document.getElementById("dateText").textContent = "Fecha: " + now.toLocaleDateString();
        document.getElementById("clockText").textContent = "Hora: " + now.toLocaleTimeString();
      }
      tick();
      setInterval(tick, 1000);
    }

    function setCrewText({pilot, nav, vehicle}) {
      document.getElementById("crewText").textContent =
        `Piloto: ${pilot} / Navegante: ${nav} / Veh√≠culo: ${vehicle}`;
    }

    function promptCrewData(oldData) {
      const pilot = prompt("Ingres√° el nombre del PILOTO:", oldData?.pilot || "Piloto") || "Piloto";
      const nav = prompt("Ingres√° el nombre del NAVEGANTE:", oldData?.nav || "Navegante") || "Navegante";
      const vehicle = prompt("Ingres√° el VEH√çCULO:", oldData?.vehicle || "Veh√≠culo") || "Veh√≠culo";
      const obj = { pilot, nav, vehicle };
      localStorage.setItem(STORAGE_CREW, JSON.stringify(obj));
      setCrewText(obj);
    }

    function loadCrew(){
      const data = localStorage.getItem(STORAGE_CREW);
      if (data){
        const parsed = JSON.parse(data);
        setCrewText({
          pilot: parsed.pilot || "-",
          nav: parsed.nav || "-",
          vehicle: parsed.vehicle || "-"
        });
      } else {
        promptCrewData(null);
      }
    }

    function saveRaceState(){ localStorage.setItem(STORAGE_RACE, JSON.stringify(raceState)); }
    function loadRaceState(){
      const data = localStorage.getItem(STORAGE_RACE);
      if (data){
        raceState = JSON.parse(data);
        if (raceState.startedAt && !raceState.isPaused) startRaceTimerLoop();
        updateRaceDisplay();
        updatePauseButtonText();
      } else {
        updateRaceDisplay();
      }
    }

    function getSelectedRally() {
      return userData.rallies.find(r => r.id === userData.selectedRallyId) || null;
    }

    function saveUserData() {
      if (!currentUser) return;
      const rally = getSelectedRally();
      if (rally) {
        rally.stages = stages;
      }
      userData.selectedStageId = selectedStageId;
      localStorage.setItem(dataKeyForUser(currentUser), JSON.stringify(userData));
    }

    function saveStages(){
      saveUserData();
      renderAutoSummary();
    }

    function calcStageDiff(stage){
      let total = 0;
      stage.points.forEach(p=>{
        if (p.realTimeMs != null) total += (p.realTimeMs - p.idealTimeMs)/1000;
      });
      return total;
    }

    // üî¢ stats de etapa (total, promedio, cantidad)
    function calcStageStats(stage){
      let sum = 0;
      let count = 0;
      stage.points.forEach(p=>{
        if (p.realTimeMs != null) {
          sum += (p.realTimeMs - p.idealTimeMs)/1000;
          count++;
        }
      });
      return {
        total: sum,
        avg: count ? sum / count : 0,
        count
      };
    }

    function calcRallyDiff(rally){
      let total = 0;
      rally.stages.forEach(stage=>{
        stage.points.forEach(p=>{
          if (p.realTimeMs != null) total += (p.realTimeMs - p.idealTimeMs)/1000;
        });
      });
      return total;
    }

    function createDefaultDataForUser() {
      const rallyName = prompt("Nombre del RALLY:", "Rally 1") || "Rally 1";
      const stageName = prompt("Nombre de la primera etapa:", "Etapa 1") || "Etapa 1";
      const rallyId = Date.now();
      const stageId = rallyId + 1;
      userData = {
        rallies: [{
          id: rallyId,
          name: rallyName,
          date: new Date().toISOString().slice(0,10),
          locked: false,
          stages: [
            { id: stageId, name: stageName, order: 1, points: [], locked:false }
          ]
        }],
        selectedRallyId: rallyId,
        selectedStageId: stageId
      };
      stages = userData.rallies[0].stages;
      selectedStageId = stageId;
      saveUserData();
      renderRallies();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
      renderAutoSummary();
    }

    function loadUserDataForCurrentUser(){
      if (!currentUser) return;
      const key = dataKeyForUser(currentUser);
      const dataStr = localStorage.getItem(key);
      if (dataStr) {
        try {
          userData = JSON.parse(dataStr);
        } catch(e) {
          userData = { rallies: [], selectedRallyId:null, selectedStageId:null };
        }
      } else {
        userData = { rallies: [], selectedRallyId:null, selectedStageId:null };
      }
      if (!userData.rallies || !userData.rallies.length) {
        createDefaultDataForUser();
        return;
      }
      if (!userData.selectedRallyId) {
        userData.selectedRallyId = userData.rallies[0].id;
      }
      const currentRally = getSelectedRally() || userData.rallies[0];
      userData.selectedRallyId = currentRally.id;
      stages = currentRally.stages || [];
      if (!userData.selectedStageId && stages.length) {
        selectedStageId = stages[0].id;
      } else {
        selectedStageId = userData.selectedStageId || (stages[0]?.id ?? null);
      }
      renderRallies();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
      renderAutoSummary();
    }

    // LOGIN
    function showLoginOverlay(){
      document.getElementById("loginOverlay").classList.remove("hidden");
    }
    function hideLoginOverlay(){
      document.getElementById("loginOverlay").classList.add("hidden");
    }

    function getUsers(){
      return JSON.parse(localStorage.getItem(STORAGE_USERS) || "[]");
    }
    function saveUsers(users){
      localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
    }

    function handleRegister(){
      const u = (document.getElementById("loginUser").value || "").trim();
      const p = document.getElementById("loginPass").value || "";
      if (!u || !p) {
        alert("Ingres√° usuario y contrase√±a para registrar.");
        return;
      }
      const users = getUsers();
      if (users.some(x => x.user === u)) {
        alert("Ese usuario ya existe. Prob√° iniciar sesi√≥n.");
        return;
      }
      users.push({ user: u, pass: p });
      saveUsers(users);
      currentUser = u;
      localStorage.setItem(STORAGE_CURRENT_USER, u);
      createDefaultDataForUser();
      hideLoginOverlay();
      alert("Usuario registrado. Ya pod√©s usar la app.");
    }

    function handleLogin(){
      const u = (document.getElementById("loginUser").value || "").trim();
      const p = document.getElementById("loginPass").value || "";
      if (!u || !p) {
        alert("Ingres√° usuario y contrase√±a.");
        return;
      }
      const users = getUsers();
      const found = users.find(x => x.user === u && x.pass === p);
      if (!found) {
        alert("Usuario o contrase√±a incorrectos.");
        return;
      }
      currentUser = u;
      localStorage.setItem(STORAGE_CURRENT_USER, u);
      hideLoginOverlay();
      loadUserDataForCurrentUser();
    }

    function initAppAfterSplash(){
      const storedUser = localStorage.getItem(STORAGE_CURRENT_USER);
      if (storedUser) {
        currentUser = storedUser;
        hideLoginOverlay();
        loadUserDataForCurrentUser();
      } else {
        showLoginOverlay();
      }
    }

    // RALLIES UI
    function renderRallies(){
      const cont = document.getElementById("ralliesContainer");
      cont.innerHTML = "";
      if (!userData.rallies || !userData.rallies.length) return;
      userData.rallies.forEach(rally=>{
        const div = document.createElement("div");
        div.className = "etapa-btn" + (rally.id === userData.selectedRallyId ? " active" : "");
        const total = calcRallyDiff(rally);
        div.innerHTML = `
          <span class="etapa-name">${rally.name}${rally.locked ? " (finalizado)" : ""}</span>
          <span class="etapa-total">${total>0?"+":""}${total.toFixed(2)} s</span>
          <span data-del="1" style="background:rgba(239,68,68,.16);padding:0 .3rem;border-radius:.3rem;cursor:pointer;">√ó</span>
        `;
        div.addEventListener("click", e=>{
          const del = e.target.getAttribute("data-del");
          const isName = e.target.classList.contains("etapa-name");
          if (del) {
            deleteRally(rally.id);
          } else if (isName) {
            renameRally(rally.id);
          } else {
            selectRally(rally.id);
          }
        });
        cont.appendChild(div);
      });
    }

    function selectRally(id){
      const rally = userData.rallies.find(r=>r.id===id);
      if (!rally) return;
      userData.selectedRallyId = id;
      stages = rally.stages || [];
      selectedStageId = stages[0]?.id ?? null;
      saveUserData();
      renderRallies();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
      renderAutoSummary();
    }

    function addRally(){
      if (!currentUser) {
        alert("Primero inici√° sesi√≥n.");
        return;
      }
      const name = prompt("Nombre del nuevo RALLY:", `Rally ${userData.rallies.length+1}`);
      if (!name) return;
      const rId = Date.now() + Math.random();
      const stageName = prompt("Nombre de la primera etapa:", "Etapa 1") || "Etapa 1";
      const stageId = rId + 1;
      const rally = {
        id: rId,
        name,
        date: new Date().toISOString().slice(0,10),
        locked: false,
        stages: [
          { id: stageId, name: stageName, order: 1, points: [], locked:false }
        ]
      };
      userData.rallies.push(rally);
      userData.selectedRallyId = rId;
      stages = rally.stages;
      selectedStageId = stageId;
      saveUserData();
      renderRallies();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
      renderAutoSummary();
    }

    function renameRally(id){
      const rally = userData.rallies.find(r=>r.id===id);
      if (!rally) return;
      const name = prompt("Nuevo nombre del RALLY:", rally.name);
      if (!name) return;
      rally.name = name;
      saveUserData();
      renderRallies();
    }

    function deleteRally(id){
      const rally = userData.rallies.find(r=>r.id===id);
      const ok = confirm(`¬øEliminar el rally "${rally?.name}" con todas sus etapas y puntos?`);
      if (!ok) return;
      userData.rallies = userData.rallies.filter(r=>r.id!==id);
      if (!userData.rallies.length){
        createDefaultDataForUser();
        return;
      }
      userData.selectedRallyId = userData.rallies[0].id;
      const currentR = getSelectedRally();
      stages = currentR.stages || [];
      selectedStageId = stages[0]?.id ?? null;
      saveUserData();
      renderRallies();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
      renderAutoSummary();
    }

    function finalizeRally(){
      const rally = getSelectedRally();
      if (!rally) return;
      if (rally.locked) {
        alert("Este rally ya est√° finalizado.");
        return;
      }
      const ok = confirm(`¬øFinalizar el rally "${rally.name}"? Se frenar√° el reloj y no podr√°s editar etapas ni puntos.`);
      if (!ok) return;
      rally.locked = true;
      // pausamos reloj
      if (raceState.startedAt && !raceState.isPaused) {
        raceState.pausedElapsed = getCurrentElapsedMs();
        raceState.isPaused = true;
        clearInterval(raceTimerInterval);
        updatePauseButtonText();
        saveRaceState();
      }
      saveUserData();
      renderRallies();
      renderStages();
      renderPointsTable();
    }

    // ETAPAS
    function renderStages(){
      const cont = document.getElementById("stagesContainer");
      cont.innerHTML = "";
      const rally = getSelectedRally();
      if (!rally) return;
      stages.sort((a,b)=>a.order-b.order).forEach(stage=>{
        const btn = document.createElement("div");
        btn.className = "etapa-btn" + (stage.id === selectedStageId ? " active" : "");
        const stats = calcStageStats(stage);
        const total = stats.total;
        const avg = stats.count ? stats.avg : null;
        btn.innerHTML = `
          <span class="etapa-name">${stage.name}${stage.locked ? " (finalizada)" : ""}</span>
          <span class="etapa-total">${total>0?"+":""}${total.toFixed(2)} s</span>
          <span class="etapa-total" style="opacity:.7;">Prom: ${avg!==null ? ((avg>0?"+":"")+avg.toFixed(2)+" s") : "-"}</span>
          <span data-del="1" style="background:rgba(239,68,68,.16);padding:0 .3rem;border-radius:.3rem;cursor:pointer;">√ó</span>
        `;
        btn.addEventListener("click", (e)=>{
          const del = e.target.getAttribute("data-del");
          const nameClick = e.target.classList.contains("etapa-name");
          if (del) {
            deleteStage(stage.id);
          } else if (nameClick) {
            renameStage(stage.id);
          } else {
            selectedStageId = stage.id;
            saveStages();
            renderStages();
            renderPointsTable();
            renderChartStageSelect();
          }
        });
        cont.appendChild(btn);
      });
      const st = stages.find(s=>s.id===selectedStageId) || null;
      document.getElementById("pointsTitle").textContent =
        st ? `Puntos de ${st.name}${st.locked ? " (finalizada)" : ""}` : "Puntos de la etapa";
    }

    function renameStage(id){
      const rally = getSelectedRally();
      if (rally && rally.locked) {
        alert("El rally est√° finalizado. No pod√©s renombrar etapas.");
        return;
      }
      const stage = stages.find(s=>s.id===id);
      if (!stage) return;
      const name = prompt("Nuevo nombre de la etapa:", stage.name);
      if (!name) return;
      stage.name = name;
      saveStages();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
    }

    function addStage(){
      const rally = getSelectedRally();
      if (!rally) {
        alert("Primero cre√° un rally.");
        return;
      }
      if (rally.locked) {
        alert("Este rally est√° finalizado. No pod√©s agregar etapas.");
        return;
      }
      const name = prompt("Nombre de la etapa:", `Etapa ${stages.length+1}`);
      if (!name) return;
      const newStage = {
        id: Date.now() + Math.random(),
        name,
        order: stages.length ? Math.max(...stages.map(s=>s.order)) + 1 : 1,
        points: [],
        locked: false
      };
      stages.push(newStage);
      selectedStageId = newStage.id;
      saveStages();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
    }

    function deleteStage(id){
      const rally = getSelectedRally();
      if (rally && rally.locked) {
        alert("El rally est√° finalizado. No pod√©s eliminar etapas.");
        return;
      }
      const stage = stages.find(s=>s.id===id);
      const ok = confirm(`¬øEliminar la etapa "${stage?.name}" y todos sus puntos?`);
      if (!ok) return;
      stages = stages.filter(s=>s.id!==id);
      if (!stages.length) {
        const firstName = prompt("Nombre de la etapa:", "Etapa 1") || "Etapa 1";
        const first = { id: Date.now(), name: firstName, order: 1, points: [], locked: false };
        stages = [first];
        selectedStageId = first.id;
      } else {
        selectedStageId = stages[0].id;
      }
      saveStages();
      renderStages();
      renderPointsTable();
      renderChartStageSelect();
    }

    function calcAdjustmentForPoint(stage, pointIdx) {
      const p = stage.points[pointIdx];
      if (p.realTimeMs == null) return null;
      const diffSec = (p.realTimeMs - p.idealTimeMs) / 1000;
      const next = stage.points
        .filter(x => x.order > p.order)
        .sort((a,b) => a.order - b.order)[0];
      if (!next) return { possible: false, reason: "√öltimo punto" };

      const idealSegMs = next.idealTimeMs - p.idealTimeMs;
      if (idealSegMs <= 0) return { possible: false, reason: "Tiempo 0" };

      let distKm = null;
      if (p.km != null && next.km != null) {
        distKm = next.km - p.km;
      } else if (p.speed != null) {
        distKm = p.speed * (idealSegMs / 3600000);
      }

      if (distKm == null || distKm <= 0) {
        return { possible: false, reason: "Sin km/vel" };
      }

      const desiredSegMs = idealSegMs - diffSec * 1000;
      if (desiredSegMs <= 200) return { possible: false, reason: "No alcanza" };

      const speedKmh = distKm * 3600000 / desiredSegMs;

      return {
        possible: true,
        speedKmh,
        durationMs: desiredSegMs,
        toName: next.name
      };
    }

    function getSelectedStage(){
      return stages.find(s => s.id === selectedStageId) || null;
    }

    function renderPointsTable(){
      const tbody = document.getElementById("pointsTable");
      tbody.innerHTML = "";
      const stage = getSelectedStage();
      if (!stage) return;
      stage.points.sort((a,b)=>a.order-b.order).forEach(p=>{
        const diffMs = p.realTimeMs != null ? p.realTimeMs - p.idealTimeMs : null;
        const diffClass = diffMs != null ? (diffMs > 0 ? "diff-red" : "diff-green") : "";
        let diffPctText = "‚Äî";
        let diffPctClass = "";
        if (p.realTimeMs != null && p.idealTimeMs > 0) {
          const diffPct = ( (p.realTimeMs - p.idealTimeMs) / p.idealTimeMs ) * 100;
          diffPctText = (diffPct > 0 ? "+" : "") + diffPct.toFixed(2) + " %";
          diffPctClass = diffPct > 0 ? "diff-red" : "diff-green";
        }
        const isAuto = p.type === "AUTO";

        let ajusteHtml = "‚Äî";
        if (p.adjustment && p.adjustment.possible) {
          let arrowHtml = "";
          if (p.speed != null) {
            if (p.adjustment.speedKmh > p.speed + 0.01) {
              arrowHtml = `<span class="adj-arrow adj-up">‚ñ≤</span>`;
            } else if (p.adjustment.speedKmh < p.speed - 0.01) {
              arrowHtml = `<span class="adj-arrow adj-down">‚ñº</span>`;
            }
          }
          ajusteHtml = `${arrowHtml}Ir a ${p.adjustment.speedKmh.toFixed(1)} km/h ‚Üí ${p.adjustment.toName}`;
        } else if (p.adjustment) {
          ajusteHtml = p.adjustment.reason;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.order}</td>
          <td>${p.name}</td>
          <td>
            <span class="tag ${isAuto ? "tag-auto" : "tag-point"}">${p.type}</span>
            ${isAuto ? '<span class="warn-badge">‚ö†</span>' : ''}
          </td>
          <td>${p.km ?? ""}</td>
          <td>${p.speed ?? ""}</td>
          <td>${formatMs(p.idealTimeMs)}</td>
          <td>${p.realTimeMs != null ? formatMs(p.realTimeMs) : "--"}</td>
          <td class="${diffClass}">${diffMs != null ? ((diffMs>0?"+":"") + (diffMs/1000).toFixed(1) + " s") : "--"}</td>
          <td class="${diffPctClass}">${diffPctText}</td>
          <td>${ajusteHtml}</td>
          <td class="actions-cell">
            ${(!stage.locked && p.realTimeMs == null) ? `<button class="markBtn" data-id="${p.id}">TOP</button>` : ""}
            ${(!stage.locked && p.realTimeMs != null) ? `<button class="restoreBtn secondary" data-id="${p.id}">Restablecer</button>` : ""}
            ${!stage.locked ? `<button class="editBtn secondary" data-id="${p.id}">Editar</button>` : ""}

            ${!stage.locked ? `<button class="delBtn secondary" data-id="${p.id}">X</button>` : ""}
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.querySelectorAll(".markBtn").forEach(btn=>{
        btn.onclick = () => markPoint(btn.dataset.id);
      });
      document.querySelectorAll(".delBtn").forEach(btn=>{
        btn.onclick = () => deletePoint(btn.dataset.id);
      });
      document.querySelectorAll(".restoreBtn").forEach(btn=>{
        btn.onclick = () => restorePoint(btn.dataset.id);
      });
      document.querySelectorAll(".editBtn").forEach(btn=>{
        btn.onclick = () => editPoint(btn.dataset.id);
      });

      const finalizeBtn = document.getElementById("finalizeStageBtn");
      const reopenBtn = document.getElementById("reopenStageBtn");
      if (stage.locked) {
        finalizeBtn.disabled = true;
        reopenBtn.disabled = false;
      } else {
        finalizeBtn.disabled = false;
        reopenBtn.disabled = true;
      }

      // resumen de etapa: total y promedio
      const summaryEl = document.getElementById("stageSummary");
      if (summaryEl) {
        const stats = calcStageStats(stage);
        if (stats.count > 0) {
          const t = stats.total;
          const a = stats.avg;
          summaryEl.textContent =
            `Etapa "${stage.name}": ${stats.count} puntos marcados. ` +
            `Total: ${t>0?"+":""}${t.toFixed(2)} s | ` +
            `Promedio: ${a>0?"+":""}${a.toFixed(2)} s por punto.`;
        } else {
          summaryEl.textContent = `Etapa "${stage.name}": sin puntos marcados a√∫n.`;
        }
      }

      if (document.getElementById("chartCard").style.display !== "none") {
        updateChart();
      }
    }

    function resetPointInputs(){
      document.getElementById("name").value = "";
      document.getElementById("hs").value = 0;
      document.getElementById("mm").value = 0;
      document.getElementById("ss").value = 0;
      document.getElementById("ml").value = 0;
      document.getElementById("km").value = "";
      document.getElementById("speed").value = "";
      document.getElementById("type").value = "POINT";
      editingPointId = null;
      document.getElementById("addBtn").textContent = "Agregar punto";
      document.getElementById("cancelEditBtn").style.display = "none";
    }

    let editingPointId = null;

    function addOrUpdatePoint(){
      const rally = getSelectedRally();
      if (!rally) return alert("Primero cre√° / seleccion√° un rally.");
      if (rally.locked) return alert("Este rally est√° finalizado. No pod√©s modificarlo.");
      const stage = getSelectedStage();
      if (!stage) return alert("Primero cre√° / seleccion√° una etapa.");
      if (stage.locked) return alert("Esta etapa est√° finalizada. No pod√©s modificarla.");

      const n = document.getElementById("name").value || ("Punto " + (stage.points.length+1));
      const t = document.getElementById("type").value;
      const h = +document.getElementById("hs").value || 0;
      const m = +document.getElementById("mm").value || 0;
      const s = +document.getElementById("ss").value || 0;
      const ml = +document.getElementById("ml").value || 0;
      const km = document.getElementById("km").value;
      const speed = document.getElementById("speed").value;
      const idealMs = toMs(h,m,s,ml);

      if (editingPointId) {
        const idx = stage.points.findIndex(p=>p.id == editingPointId);
        if (idx !== -1) {
          const old = stage.points[idx];
          stage.points[idx] = {
            ...old,
            name: n,
            type: t,
            idealTimeMs: idealMs,
            km: km ? +km : null,
            speed: speed ? +speed : null,
            adjustment: null
          };
        }
      } else {
        const newPoint = {
          id: Date.now() + Math.random(),
          order: stage.points.length ? Math.max(...stage.points.map(p=>p.order))+1 : 1,
          name: n,
          type: t,
          idealTimeMs: idealMs,
          km: km ? +km : null,
          speed: speed ? +speed : null,
          realTimeMs: null,
          adjustment: null
        };
        stage.points.push(newPoint);
      }

      saveStages();
      renderPointsTable();
      renderStages();
      resetPointInputs();
    }

    function editPoint(pointId){
      const rally = getSelectedRally();
      if (rally && rally.locked) return;
      const stage = getSelectedStage();
      if (!stage) return;
      if (stage.locked) return;
      const p = stage.points.find(pt => pt.id == pointId);
      if (!p) return;
      document.getElementById("name").value = p.name;
      document.getElementById("type").value = p.type;
      let ms = p.idealTimeMs;
      const h = Math.floor(ms / 3600000); ms %= 3600000;
      const m = Math.floor(ms / 60000); ms %= 60000;
      const s = Math.floor(ms / 1000);
      const ml = ms % 1000;
      document.getElementById("hs").value = h;
      document.getElementById("mm").value = m;
      document.getElementById("ss").value = s;
      document.getElementById("ml").value = ml;
      document.getElementById("km").value = p.km ?? "";
      document.getElementById("speed").value = p.speed ?? "";
      editingPointId = p.id;
      document.getElementById("addBtn").textContent = "Guardar cambios";
      document.getElementById("cancelEditBtn").style.display = "inline-block";
    }

    // ==== DIBUJO MANUAL DEL GR√ÅFICO EN CANVAS (PANTALLA) ====
    function drawStageChartOnCanvas(stage, canvas) {
      if (!canvas || !stage) return;
      const ctx = canvas.getContext("2d");

      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      if (rect.width && rect.height) {
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
      }
      const width = canvas.width;
      const height = canvas.height;

      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,width,height);

      const points = stage.points
        .filter(p => p.realTimeMs != null)
        .sort((a,b) => a.order - b.order);

      if (!points.length) {
        ctx.fillStyle = "#9ca3af";
        ctx.font = `${12 * dpr}px system-ui`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("Marc√° al menos un TOP para ver diferencias", width/2, height/2);
        return;
      }

      const diffs = points.map(p => (p.realTimeMs - p.idealTimeMs)/1000);
      let minVal = Math.min(...diffs, 0);
      let maxVal = Math.max(...diffs, 0);
      const padVal = 0.2;
      minVal -= padVal;
      maxVal += padVal;
      if (minVal === maxVal) {
        minVal -= 1;
        maxVal += 1;
      }

      const padLeft = 50 * dpr;
      const padRight = 16 * dpr;
      const padTop = 20 * dpr;
      const padBottom = 30 * dpr;

      const plotW = width - padLeft - padRight;
      const plotH = height - padTop - padBottom;

      function yForValue(v) {
        const t = (v - minVal) / (maxVal - minVal);
        return padTop + (1 - t) * plotH;
      }
      function xForIndex(i) {
        if (points.length === 1) return padLeft + plotW/2;
        return padLeft + (i / (points.length - 1)) * plotW;
      }

      ctx.fillStyle = "#020617";
      ctx.fillRect(0,0,width,height);

      ctx.strokeStyle = "#4b5563";
      ctx.lineWidth = 1 * dpr;
      ctx.beginPath();
      ctx.moveTo(padLeft, padTop);
      ctx.lineTo(padLeft, padTop + plotH);
      ctx.lineTo(padLeft + plotW, padTop + plotH);
      ctx.stroke();

      const y0 = yForValue(0);
      ctx.strokeStyle = "#64748b";
      ctx.setLineDash([4 * dpr, 4 * dpr]);
      ctx.beginPath();
      ctx.moveTo(padLeft, y0);
      ctx.lineTo(padLeft + plotW, y0);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.strokeStyle = "#22c55e";
      ctx.lineWidth = 2 * dpr;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = xForIndex(i);
        const y = yForValue(diffs[i]);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = "#22c55e";
      points.forEach((p, i) => {
        const x = xForIndex(i);
        const y = yForValue(diffs[i]);
        ctx.beginPath();
        ctx.arc(x, y, 3 * dpr, 0, Math.PI*2);
        ctx.fill();
      });

      ctx.fillStyle = "#9ca3af";
      ctx.font = `${10 * dpr}px system-ui`;
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(maxVal.toFixed(1) + " s", padLeft - 4 * dpr, yForValue(maxVal));
      ctx.fillText("0 s", padLeft - 4 * dpr, y0);
      ctx.fillText(minVal.toFixed(1) + " s", padLeft - 4 * dpr, yForValue(minVal));

      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      points.forEach((p, i) => {
        const x = xForIndex(i);
        const label = (p.name || ("P" + p.order));
        const shortLabel = label.length > 6 ? label.slice(0,6) + "‚Ä¶" : label;
        ctx.fillText(shortLabel, x, padTop + plotH + 4 * dpr);
      });
    }

    // ==== DIBUJO MANUAL PARA PDF ====
    function drawStageChartForPDF(stage) {
      const canvas = document.getElementById("pdfChartCanvas");
      if (!canvas || !stage) return false;
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,width,height);

      const points = stage.points
        .filter(p => p.realTimeMs != null)
        .sort((a,b) => a.order - b.order);

      if (!points.length) return false;

      const diffs = points.map(p => (p.realTimeMs - p.idealTimeMs)/1000);
      let minVal = Math.min(...diffs, 0);
      let maxVal = Math.max(...diffs, 0);
      const padVal = 0.2;
      minVal -= padVal;
      maxVal += padVal;
      if (minVal === maxVal) {
        minVal -= 1;
        maxVal += 1;
      }

      const padLeft = 60;
      const padRight = 30;
      const padTop = 30;
      const padBottom = 40;
      const plotW = width - padLeft - padRight;
      const plotH = height - padTop - padBottom;

      function yForValue(v) {
        const t = (v - minVal) / (maxVal - minVal);
        return padTop + (1 - t) * plotH;
      }
      function xForIndex(i) {
        if (points.length === 1) return padLeft + plotW/2;
        return padLeft + (i / (points.length - 1)) * plotW;
      }

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,width,height);

      ctx.strokeStyle = "#4b5563";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padLeft, padTop);
      ctx.lineTo(padLeft, padTop + plotH);
      ctx.lineTo(padLeft + plotW, padTop + plotH);
      ctx.stroke();

      const y0 = yForValue(0);
      ctx.strokeStyle = "#9ca3af";
      ctx.setLineDash([4,4]);
      ctx.beginPath();
      ctx.moveTo(padLeft, y0);
      ctx.lineTo(padLeft + plotW, y0);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.strokeStyle = "#16a34a";
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p, i) => {
        const x = xForIndex(i);
        const y = yForValue(diffs[i]);
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = "#16a34a";
      points.forEach((p, i) => {
        const x = xForIndex(i);
        const y = yForValue(diffs[i]);
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI*2);
        ctx.fill();
      });

      ctx.fillStyle = "#111827";
      ctx.font = "10px system-ui";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(maxVal.toFixed(1) + " s", padLeft - 6, yForValue(maxVal));
      ctx.fillText("0 s", padLeft - 6, y0);
      ctx.fillText(minVal.toFixed(1) + " s", padLeft - 6, yForValue(minVal));

      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      points.forEach((p, i) => {
        const x = xForIndex(i);
        const label = (p.name || ("P" + p.order));
        const shortLabel = label.length > 8 ? label.slice(0,8) + "‚Ä¶" : label;
        ctx.fillText(shortLabel, x, padTop + plotH + 6);
      });

      ctx.font = "12px system-ui";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText("Diferencia vs tiempo ideal (s)", padLeft, 8);

      return true;
    }

    function makeStageChartImage(stage) {
      return new Promise((resolve) => {
        const ok = drawStageChartForPDF(stage);
        if (!ok) {
          resolve(null);
          return;
        }
        const canvas = document.getElementById("pdfChartCanvas");
        const imgData = canvas.toDataURL("image/png");
        resolve(imgData);
      });
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });

      const crewData = JSON.parse(localStorage.getItem(STORAGE_CREW) || '{"pilot":"-","nav":"-","vehicle":"-"}');
      const rally = getSelectedRally();

      doc.setFontSize(18);
      doc.text("üìã Reporte de Regularidad", 14, 15);
      doc.setFontSize(10);
      doc.text(`Piloto: ${crewData.pilot}   Navegante: ${crewData.nav}   Veh√≠culo: ${crewData.vehicle}`, 14, 21);
      doc.text(`Rally: ${rally ? rally.name : "-"}`, 14, 27);
      doc.text(`Generado: ${new Date().toLocaleString()}`, 14, 33);

      let y = 40;
      const currentStages = stages || [];

      for (const stage of currentStages) {
        doc.setFontSize(14);
        const stats = calcStageStats(stage);
        const lineTxt = `Etapa: ${stage.name}${stage.locked ? " (finalizada)" : ""}  |  Total: ${(stats.total>0?"+":"")+stats.total.toFixed(2)} s  |  Prom: ${(stats.count>0 ? ((stats.avg>0?"+":"")+stats.avg.toFixed(2)+" s") : "-")}`;
        doc.text(lineTxt, 14, y);
        y += 6;

        const rows = stage.points
          .sort((a, b) => a.order - b.order)
          .map(p => {
            const diff = (p.realTimeMs != null)
              ? ((p.realTimeMs - p.idealTimeMs) / 1000).toFixed(2)
              : "";
            let diffPct = "";
            if (p.realTimeMs != null && p.idealTimeMs > 0) {
              const pct = ((p.realTimeMs - p.idealTimeMs) / p.idealTimeMs) * 100;
              diffPct = (pct > 0 ? "+" : "") + pct.toFixed(2) + " %";
            }
            let adjText = "‚Äî";
            if (p.adjustment && p.adjustment.possible) {
              let arrowTxt = "";
              if (p.speed != null) {
                if (p.adjustment.speedKmh > p.speed + 0.01) arrowTxt = "‚Üë ";
                else if (p.adjustment.speedKmh < p.speed - 0.01) arrowTxt = "‚Üì ";
              }
              adjText = `${arrowTxt}Ir a ${p.adjustment.speedKmh.toFixed(1)} km/h ‚Üí ${p.adjustment.toName}`;
            } else if (p.adjustment) {
              adjText = p.adjustment.reason;
            }
            return [
              p.order,
              p.name,
              p.type,
              p.km ?? "",
              p.speed ?? "",
              formatMs(p.idealTimeMs),
              formatMs(p.realTimeMs),
              diff,
              diffPct,
              adjText
            ];
          });

        doc.autoTable({
          startY: y,
          head: [["#", "Punto", "Tipo", "Km", "Vel (km/h)", "Ideal", "Real", "Dif (s)", "Dif (%)", "Ajuste"]],
          body: rows,
          theme: "striped",
          headStyles: { fillColor: [34, 197, 94], textColor: 0 },
          styles: { fontSize: 8 },
          columnStyles: {
            9: { cellWidth: 60 }
          }
        });

        y = doc.lastAutoTable.finalY + 4;

        const imgData = await makeStageChartImage(stage);
        if (imgData) {
          const imgWidth = 250;
          const imgHeight = 90;
          if (y + imgHeight > 190) {
            doc.addPage();
            y = 20;
          }
          doc.text("Gr√°fico de diferencias", 14, y);
          y += 3;
          doc.addImage(imgData, "PNG", 14, y, imgWidth, imgHeight);
          y += imgHeight + 8;
        } else {
          y += 4;
        }

        if (y > 185) {
          doc.addPage();
          y = 20;
        }
      }

      let totalAuto = 0;
      currentStages.forEach(stage => {
        stage.points.forEach(p => {
          if (p.type === "AUTO" && p.realTimeMs != null) {
            totalAuto += (p.realTimeMs - p.idealTimeMs) / 1000;
          }
        });
      });
      doc.setFontSize(12);
      if (y > 180) {
        doc.addPage();
        y = 20;
      }
      doc.text(`Total AUTOCONTROLES (rally actual): ${totalAuto > 0 ? "+" : ""}${totalAuto.toFixed(2)} s`, 14, y + 5);

      const fecha = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
      doc.save(`regularidad-${rally ? rally.name.replace(/\s+/g,"_") : "rally"}-${fecha}.pdf`);
    }

    function markPoint(pointId){
      const rally = getSelectedRally();
      if (!rally) return alert("Primero cre√° / seleccion√° un rally.");
      if (rally.locked) return alert("Este rally est√° finalizado. No pod√©s marcar puntos.");
      if (!raceState.startedAt) return alert("Primero larg√° la carrera.");
      const stage = getSelectedStage();
      if (!stage) return;
      if (stage.locked) return alert("Esta etapa est√° finalizada. No pod√©s marcar m√°s puntos.");
      const idx = stage.points.findIndex(p=>p.id == pointId);
      if (idx === -1) return;
      const realMs = getCurrentElapsedMs();
      stage.points[idx] = { ...stage.points[idx], realTimeMs: realMs };
      const adj = calcAdjustmentForPoint(stage, idx);
      stage.points[idx].adjustment = adj;
      saveStages();
      renderPointsTable();
      renderStages();
    }

    function restorePoint(pointId){
      const rally = getSelectedRally();
      if (rally && rally.locked) return alert("El rally est√° finalizado. No pod√©s restablecer puntos.");
      const stage = getSelectedStage();
      if (!stage) return;
      if (stage.locked) return alert("Esta etapa est√° finalizada. No pod√©s restablecer.");
      const idx = stage.points.findIndex(p=>p.id == pointId);
      if (idx === -1) return;
      const ok = confirm("¬øRestablecer este punto? Se borrar√° el tiempo real.");
      if (!ok) return;
      stage.points[idx].realTimeMs = null;
      stage.points[idx].adjustment = null;
      saveStages();
      renderPointsTable();
      renderStages();
    }

    function deletePoint(pointId){
      const rally = getSelectedRally();
      if (rally && rally.locked) return alert("El rally est√° finalizado. No pod√©s eliminar puntos.");
      const stage = getSelectedStage();
      if (!stage) return;
      if (stage.locked) return alert("Esta etapa est√° finalizada. No pod√©s eliminar puntos.");
      const point = stage.points.find(p=>p.id == pointId);
      const ok = confirm(`¬øSeguro que quer√©s eliminar el punto "${point?.name ?? ""}"?`);
      if (!ok) return;
      stage.points = stage.points.filter(p=>p.id != pointId);
      saveStages();
      renderPointsTable();
      renderStages();
    }

    function renderChartStageSelect(){
      const sel = document.getElementById("chartStageSelect");
      sel.innerHTML = "";
      stages.sort((a,b)=>a.order-b.order).forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.name + (s.locked ? " (finalizada)" : "");
        if (s.id === selectedStageId) opt.selected = true;
        sel.appendChild(opt);
      });
      sel.onchange = () => {
        selectedStageId = Number(sel.value);
        saveStages();
        updateChart();
      };
    }

    function updateChart(){
      const stage = getSelectedStage();
      if (!stage) return;
      const canvas = document.getElementById("diffChart");
      drawStageChartOnCanvas(stage, canvas);
    }

    function toggleChart(){
      const card = document.getElementById("chartCard");
      if (card.style.display === "none" || card.style.display === "") {
        card.style.display = "block";
        renderChartStageSelect();
        setTimeout(() => {
          updateChart();
        }, 100);
        document.getElementById("toggleChartBtn").textContent = "üìä Ocultar gr√°fico";
      } else {
        card.style.display = "none";
        document.getElementById("toggleChartBtn").textContent = "üìä Ver gr√°fico";
      }
    }

    function renderAutoSummary(){
      let totalAuto = 0;
      stages.forEach(stage=>{
        stage.points.forEach(p=>{
          if (p.type === "AUTO" && p.realTimeMs != null) {
            totalAuto += (p.realTimeMs - p.idealTimeMs)/1000;
          }
        });
      });
      document.getElementById("autoSummary").textContent =
        `Total AUTOCONTROLES (rally actual, todas las etapas): ${totalAuto>0?"+":""}${totalAuto.toFixed(2)} s`;
    }

    function startRace(){
      const rally = getSelectedRally();
      if (!rally) return alert("Primero cre√° / seleccion√° un rally.");
      if (rally.locked) return alert("Este rally est√° finalizado. No pod√©s largar.");
      if (!raceState.startedAt){
        raceState.startedAt = Date.now();
        raceState.isPaused = false;
        raceState.pausedElapsed = 0;
      } else if (raceState.isPaused){
        raceState.startedAt = Date.now() - raceState.pausedElapsed;
        raceState.isPaused = false;
      }
      saveRaceState();
      startRaceTimerLoop();
      updatePauseButtonText();
    }

    function pauseRace(){
      if (!raceState.startedAt) return;
      if (raceState.isPaused){
        raceState.startedAt = Date.now() - raceState.pausedElapsed;
        raceState.isPaused = false;
        startRaceTimerLoop();
      } else {
        raceState.pausedElapsed = getCurrentElapsedMs();
        raceState.isPaused = true;
        clearInterval(raceTimerInterval);
      }
      saveRaceState();
      updatePauseButtonText();
      updateRaceDisplay();
    }

    function updatePauseButtonText(){
      document.getElementById("pauseBtn").textContent = raceState.isPaused ? "Reanudar" : "Pausar";
    }

    function resetRace(){
      const ok = confirm("¬øSeguro que quer√©s reiniciar el cron√≥metro? Esto borra los tiempos REALES de los puntos del rally actual.");
      if (!ok) return;
      raceState = { startedAt: null, isPaused: false, pausedElapsed: 0 };
      saveRaceState();
      clearInterval(raceTimerInterval);
      document.getElementById("raceTime").textContent = "00:00:00.000";
      const inline = document.getElementById("raceTimeInline");
      if (inline) inline.textContent = "00:00:00.000";

      stages.forEach(s=>{
        s.points = s.points.map(p=>({ ...p, realTimeMs: null, adjustment: null }));
        s.locked = false;
      });
      const rally = getSelectedRally();
      if (rally) rally.locked = false;

      saveStages();
      renderPointsTable();
      renderStages();
      renderAutoSummary();
      updatePauseButtonText();

      const canvas = document.getElementById("diffChart");
      if (canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
    }

    function clearAllPoints(){
      const rally = getSelectedRally();
      if (rally && rally.locked) {
        alert("El rally est√° finalizado. No pod√©s borrar sus puntos.");
        return;
      }
      const ok = confirm("¬øSeguro que quer√©s borrar todos los puntos de TODAS las etapas del rally actual?");
      if (!ok) return;
      stages.forEach(s=>{ s.points = []; s.locked = false; });
      saveStages();
      renderPointsTable();
      renderStages();
      renderAutoSummary();
      const canvas = document.getElementById("diffChart");
      if (canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0,0,canvas.width,canvas.height);
      }
    }

    function finalizeStage(){
      const rally = getSelectedRally();
      if (rally && rally.locked) {
        alert("El rally est√° finalizado. No pod√©s cambiar sus etapas.");
        return;
      }
      const stage = getSelectedStage();
      if (!stage) return;
      if (stage.locked) {
        alert("Esta etapa ya est√° finalizada.");
        return;
      }
      const ok = confirm(`¬øFinalizar la etapa "${stage.name}"? No vas a poder marcar ni borrar m√°s puntos de esta etapa.`);
      if (!ok) return;
      stage.locked = true;
      saveStages();
      renderStages();
      renderPointsTable();
    }

    function reopenStage(){
      const rally = getSelectedRally();
      if (rally && rally.locked) {
        alert("El rally est√° finalizado. No pod√©s reabrir etapas.");
        return;
      }
      const stage = getSelectedStage();
      if (!stage) return;
      if (!stage.locked) {
        alert("Esta etapa ya est√° abierta.");
        return;
      }
      const ok = confirm(`¬øReabrir la etapa "${stage.name}"? Podr√°s volver a marcar y editar puntos.`);
      if (!ok) return;
      stage.locked = false;
      saveStages();
      renderStages();
      renderPointsTable();
    }

    // BARRA DE CARGA / SPLASH
    function startSplash() {
      const splash = document.getElementById("splash");
      const bar = document.getElementById("splashBarFill");
      const percentText = document.getElementById("splashPercent");
      const logo = document.getElementById("splashLogo");
      if (logo && SPLASH_IMAGE_URL) {
        logo.src = SPLASH_IMAGE_URL;
      }

      const start = performance.now();

      function step(now) {
        const elapsed = now - start;
        let pct = Math.min(100, Math.round((elapsed / SPLASH_DURATION) * 100));
        bar.style.width = pct + "%";
        percentText.textContent = pct + "%";

        if (elapsed < SPLASH_DURATION) {
          requestAnimationFrame(step);
        } else {
          bar.style.width = "100%";
          percentText.textContent = "100%";
          splash.classList.add("hidden");
          setTimeout(() => {
            splash.style.display = "none";
            initAppAfterSplash();
          }, 400);
        }
      }

      requestAnimationFrame(step);
    }

    // TOP autom√°tico (barra espaciadora / bot√≥n grande)
    function markNextPendingPoint() {
      const rally = getSelectedRally();
      if (!rally || rally.locked) return;
      if (!raceState.startedAt || raceState.isPaused) return;
      const stage = getSelectedStage();
      if (!stage || stage.locked) return;
      const nextPoint = stage.points
        .slice()
        .sort((a,b) => a.order - b.order)
        .find(p => p.realTimeMs == null);
      if (nextPoint) {
        markPoint(nextPoint.id);
      }
    }

    // FULLSCREEN
    function toggleFullscreen(){
      const docEl = document.documentElement;
      if (!document.fullscreenElement && docEl.requestFullscreen) {
        docEl.requestFullscreen();
      } else if (document.fullscreenElement && document.exitFullscreen) {
        document.exitFullscreen();
      }
    }

    document.addEventListener("fullscreenchange", () => {
      const btn = document.getElementById("fullscreenBtn");
      if (!btn) return;
      if (document.fullscreenElement) {
        btn.textContent = "‚õ∂ Salir pantalla completa";
      } else {
        btn.textContent = "‚õ∂ Pantalla completa";
      }
    });

    // EVENTOS DE BOTONES
    document.getElementById("addBtn").onclick = addOrUpdatePoint;
    document.getElementById("cancelEditBtn").onclick = resetPointInputs;
    document.getElementById("startBtn").onclick = startRace;
    document.getElementById("pauseBtn").onclick = pauseRace;
    document.getElementById("resetBtn").onclick = resetRace;
    document.getElementById("clearBtn").onclick = clearAllPoints;
    document.getElementById("toggleChartBtn").onclick = toggleChart;
    document.getElementById("addStageBtn").onclick = addStage;
    document.getElementById("exportBtn").onclick = exportPDF;
    document.getElementById("finalizeStageBtn").onclick = finalizeStage;
    document.getElementById("reopenStageBtn").onclick = reopenStage;
    document.getElementById("changeCrewBtn").onclick = () => {
      const current = JSON.parse(localStorage.getItem(STORAGE_CREW) || '{}');
      promptCrewData(current);
    };
    document.getElementById("bigTopBtn").onclick = () => {
      markNextPendingPoint();
    };

    document.getElementById("addRallyBtn").onclick = addRally;
    document.getElementById("finalizeRallyBtn").onclick = finalizeRally;

    document.getElementById("loginBtn").onclick = handleLogin;
    document.getElementById("registerBtn").onclick = handleRegister;

    document.getElementById("fullscreenBtn").onclick = toggleFullscreen;

    startClock();
    loadCrew();
    loadRaceState();
    startSplash();

    // barra espaciadora = TOP del siguiente punto (solo si no est√°s escribiendo)
    document.addEventListener("keydown", function(e) {
      const tag = e.target.tagName.toLowerCase();
      if (tag === "input" || tag === "textarea" || tag === "select" || e.target.isContentEditable) {
        return;
      }
      if (e.code === "Space" || e.key === " ") {
        e.preventDefault();
        markNextPendingPoint();
      }
    });
  </script>
</body>
</html>
